name: Build and Release APK

on:
  push:
    tags:
      - 'v*'  # 当推送 v* 标签时触发（如 v1.0.0）
  workflow_dispatch:  # 允许手动触发
    inputs:
      release_tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: false
        default: 'v1.0.0'

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Generate keystore
        run: |
          # 生成用于签名的 keystore
          keytool -genkey -v \
            -keystore app/keystore.jks \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -alias pushup-key \
            -storepass android123 \
            -keypass android123 \
            -dname "CN=PushUp Counter, OU=Development, O=PushUp, L=City, S=State, C=CN"
          
          # 创建 keystore.properties 文件
          echo "storePassword=android123" > keystore.properties
          echo "keyPassword=android123" >> keystore.properties
          echo "keyAlias=pushup-key" >> keystore.properties
          echo "storeFile=keystore.jks" >> keystore.properties
      
      - name: Build Debug APK
        run: ./gradlew assembleDebug --stacktrace
      
      - name: Build Release APK
        run: ./gradlew assembleRelease --stacktrace
      
      - name: Rename APK files
        run: |
          mkdir -p outputs
          cp app/build/outputs/apk/debug/app-debug.apk outputs/PushUpCounter-Debug.apk
          cp app/build/outputs/apk/release/app-release.apk outputs/PushUpCounter-Release.apk
      
      - name: Get APK info
        id: apk_info
        run: |
          DEBUG_SIZE=$(du -h outputs/PushUpCounter-Debug.apk | cut -f1)
          RELEASE_SIZE=$(du -h outputs/PushUpCounter-Release.apk | cut -f1)
          echo "debug_size=${DEBUG_SIZE}" >> $GITHUB_OUTPUT
          echo "release_size=${RELEASE_SIZE}" >> $GITHUB_OUTPUT
      
      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: PushUpCounter-Debug
          path: outputs/PushUpCounter-Debug.apk
          retention-days: 30
      
      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: PushUpCounter-Release
          path: outputs/PushUpCounter-Release.apk
          retention-days: 30
      
      - name: Get version from tag or input
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.release_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            outputs/PushUpCounter-Debug.apk
            outputs/PushUpCounter-Release.apk
          body: |
            ## 俯卧撑计数器 ${{ steps.version.outputs.tag }}
            
            ### 📦 下载说明
            
            本次发布包含两个版本的APK：
            
            - **PushUpCounter-Release.apk** (推荐)
              - 大小: ${{ steps.apk_info.outputs.release_size }}
              - 优化版本，体积更小，性能更好
              - 适合日常使用
            
            - **PushUpCounter-Debug.apk**
              - 大小: ${{ steps.apk_info.outputs.debug_size }}
              - 包含调试信息
              - 适合开发测试
            
            ### 📱 安装方法
            
            1. 下载对应的APK文件到您的Android设备
            2. 点击APK文件开始安装
            3. 如果提示"未知来源"，请在设置中允许从该来源安装应用
            
            ### ⚠️ 注意事项
            
            - 最低Android版本要求: Android 7.0 (API 24)
            - 需要相机权限用于姿势识别
            
            ### 🔧 通过ADB安装
            
            ```bash
            adb install -r PushUpCounter-Release.apk
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create Release (Manual)
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          files: |
            outputs/PushUpCounter-Debug.apk
            outputs/PushUpCounter-Release.apk
          body: |
            ## 俯卧撑计数器 ${{ steps.version.outputs.tag }}
            
            ### 📦 下载说明
            
            本次发布包含两个版本的APK：
            
            - **PushUpCounter-Release.apk** (推荐)
              - 大小: ${{ steps.apk_info.outputs.release_size }}
              - 优化版本，体积更小，性能更好
              - 适合日常使用
            
            - **PushUpCounter-Debug.apk**
              - 大小: ${{ steps.apk_info.outputs.debug_size }}
              - 包含调试信息
              - 适合开发测试
            
            ### 📱 安装方法
            
            1. 下载对应的APK文件到您的Android设备
            2. 点击APK文件开始安装
            3. 如果提示"未知来源"，请在设置中允许从该来源安装应用
            
            ### ⚠️ 注意事项
            
            - 最低Android版本要求: Android 7.0 (API 24)
            - 需要相机权限用于姿势识别
            
            ### 🔧 通过ADB安装
            
            ```bash
            adb install -r PushUpCounter-Release.apk
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
