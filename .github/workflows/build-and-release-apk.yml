name: Build and Release APK

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v* æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      release_tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: false
        default: 'v1.0.0'

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Generate keystore
        run: |
          # ç”Ÿæˆç”¨äºç­¾åçš„ keystore
          keytool -genkey -v \
            -keystore app/keystore.jks \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -alias pushup-key \
            -storepass android123 \
            -keypass android123 \
            -dname "CN=PushUp Counter, OU=Development, O=PushUp, L=City, S=State, C=CN"
          
          # åˆ›å»º keystore.properties æ–‡ä»¶
          echo "storePassword=android123" > keystore.properties
          echo "keyPassword=android123" >> keystore.properties
          echo "keyAlias=pushup-key" >> keystore.properties
          echo "storeFile=keystore.jks" >> keystore.properties
      
      - name: Build Debug APK
        run: ./gradlew assembleDebug --stacktrace
      
      - name: Build Release APK
        run: ./gradlew assembleRelease --stacktrace
      
      - name: Rename APK files
        run: |
          mkdir -p outputs
          cp app/build/outputs/apk/debug/app-debug.apk outputs/PushUpCounter-Debug.apk
          cp app/build/outputs/apk/release/app-release.apk outputs/PushUpCounter-Release.apk
      
      - name: Get APK info
        id: apk_info
        run: |
          DEBUG_SIZE=$(du -h outputs/PushUpCounter-Debug.apk | cut -f1)
          RELEASE_SIZE=$(du -h outputs/PushUpCounter-Release.apk | cut -f1)
          echo "debug_size=${DEBUG_SIZE}" >> $GITHUB_OUTPUT
          echo "release_size=${RELEASE_SIZE}" >> $GITHUB_OUTPUT
      
      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: PushUpCounter-Debug
          path: outputs/PushUpCounter-Debug.apk
          retention-days: 30
      
      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: PushUpCounter-Release
          path: outputs/PushUpCounter-Release.apk
          retention-days: 30
      
      - name: Get version from tag or input
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.release_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            outputs/PushUpCounter-Debug.apk
            outputs/PushUpCounter-Release.apk
          body: |
            ## ä¿¯å§æ’‘è®¡æ•°å™¨ ${{ steps.version.outputs.tag }}
            
            ### ğŸ“¦ ä¸‹è½½è¯´æ˜
            
            æœ¬æ¬¡å‘å¸ƒåŒ…å«ä¸¤ä¸ªç‰ˆæœ¬çš„APKï¼š
            
            - **PushUpCounter-Release.apk** (æ¨è)
              - å¤§å°: ${{ steps.apk_info.outputs.release_size }}
              - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œä½“ç§¯æ›´å°ï¼Œæ€§èƒ½æ›´å¥½
              - é€‚åˆæ—¥å¸¸ä½¿ç”¨
            
            - **PushUpCounter-Debug.apk**
              - å¤§å°: ${{ steps.apk_info.outputs.debug_size }}
              - åŒ…å«è°ƒè¯•ä¿¡æ¯
              - é€‚åˆå¼€å‘æµ‹è¯•
            
            ### ğŸ“± å®‰è£…æ–¹æ³•
            
            1. ä¸‹è½½å¯¹åº”çš„APKæ–‡ä»¶åˆ°æ‚¨çš„Androidè®¾å¤‡
            2. ç‚¹å‡»APKæ–‡ä»¶å¼€å§‹å®‰è£…
            3. å¦‚æœæç¤º"æœªçŸ¥æ¥æº"ï¼Œè¯·åœ¨è®¾ç½®ä¸­å…è®¸ä»è¯¥æ¥æºå®‰è£…åº”ç”¨
            
            ### âš ï¸ æ³¨æ„äº‹é¡¹
            
            - æœ€ä½Androidç‰ˆæœ¬è¦æ±‚: Android 7.0 (API 24)
            - éœ€è¦ç›¸æœºæƒé™ç”¨äºå§¿åŠ¿è¯†åˆ«
            
            ### ğŸ”§ é€šè¿‡ADBå®‰è£…
            
            ```bash
            adb install -r PushUpCounter-Release.apk
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create Release (Manual)
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          files: |
            outputs/PushUpCounter-Debug.apk
            outputs/PushUpCounter-Release.apk
          body: |
            ## ä¿¯å§æ’‘è®¡æ•°å™¨ ${{ steps.version.outputs.tag }}
            
            ### ğŸ“¦ ä¸‹è½½è¯´æ˜
            
            æœ¬æ¬¡å‘å¸ƒåŒ…å«ä¸¤ä¸ªç‰ˆæœ¬çš„APKï¼š
            
            - **PushUpCounter-Release.apk** (æ¨è)
              - å¤§å°: ${{ steps.apk_info.outputs.release_size }}
              - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œä½“ç§¯æ›´å°ï¼Œæ€§èƒ½æ›´å¥½
              - é€‚åˆæ—¥å¸¸ä½¿ç”¨
            
            - **PushUpCounter-Debug.apk**
              - å¤§å°: ${{ steps.apk_info.outputs.debug_size }}
              - åŒ…å«è°ƒè¯•ä¿¡æ¯
              - é€‚åˆå¼€å‘æµ‹è¯•
            
            ### ğŸ“± å®‰è£…æ–¹æ³•
            
            1. ä¸‹è½½å¯¹åº”çš„APKæ–‡ä»¶åˆ°æ‚¨çš„Androidè®¾å¤‡
            2. ç‚¹å‡»APKæ–‡ä»¶å¼€å§‹å®‰è£…
            3. å¦‚æœæç¤º"æœªçŸ¥æ¥æº"ï¼Œè¯·åœ¨è®¾ç½®ä¸­å…è®¸ä»è¯¥æ¥æºå®‰è£…åº”ç”¨
            
            ### âš ï¸ æ³¨æ„äº‹é¡¹
            
            - æœ€ä½Androidç‰ˆæœ¬è¦æ±‚: Android 7.0 (API 24)
            - éœ€è¦ç›¸æœºæƒé™ç”¨äºå§¿åŠ¿è¯†åˆ«
            
            ### ğŸ”§ é€šè¿‡ADBå®‰è£…
            
            ```bash
            adb install -r PushUpCounter-Release.apk
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
